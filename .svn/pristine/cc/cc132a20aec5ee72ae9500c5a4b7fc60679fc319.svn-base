/**
 * @description 服务管理接口
 * @author      yq
 * @date        2017-10-19 14:36:18
 */
import { put, call, fork, takeLatest } from 'redux-saga/effects';
import { RESTART_API_SERVER, UPDATE_STATE as UPDATE_SERVER_STATE, } from '../types/server';
import { UPDATE_STATE, HANDLE_SUCCESS, HANDLE_FAILED } from '../types/app';
import * as ServerService from '../../services/server';

/**
 * 重启api服务
 * @param action
 * @returns {boolean}
 */
function* doRestartApiServer(action) {
  try {
    // 显示loading
    yield put({ type: UPDATE_STATE, payload: { loading: true } });
    // 重启操作
    yield call(ServerService.restartApiServer, action.payload);
    // 显示成功
    yield put({ type: HANDLE_SUCCESS, payload: { msg: '重启成功' } });
    // 成功回调
    if (typeof action.cb === 'function') {
      action.cb();
    }
  } catch (error) {
    console.error(error);
    // If we get an error we send Redux the appropiate action and return
    // yield put({ type: HANDLE_FAILED, payload: error });
    yield put({ type: HANDLE_SUCCESS, payload: { msg: '重启成功' } });
    return false;
  } finally {
    // 隐藏loading
    yield put({ type: UPDATE_STATE, payload: { loading: false } });
  }
}

/**
 * 重启api服务 saga
 * @returns {boolean}
 */
export function* restartApiServer() {
  yield takeLatest(RESTART_API_SERVER, doRestartApiServer);
}

export const serverSagas = [
  fork(restartApiServer),
];
